{% extends 'app/base.html' %}
{% load static %}
{% load staticfiles %}
{% block body1 %}
    {% include "app/modal.html" %}
{% endblock %}
{% block body2 %}
<p id="githubLoginLink" hidden> {% url 'social:begin' 'github' %}</p>
{% if github_login %}
<p id="githubLogin" hidden>True</p>
{% else %}
<p id="githubLogin" hidden>False</p>
{% endif %}
<div id="messages" class="messages">
</div>
<p class ="lead"> {{ medialink }}</p>
<p class ="lead"> {{ error }}</p>
<div class="panel panel-default">
<div class="panel-heading"> <p class="lead">Submit a New License to the SPDX Licenses List</p> </div>
<div class="panel-body">
<form id="newlicense" enctype="multipart/form-data" class = "form-horizontal" method = "post" action='/submit_new_license/'>
		{% csrf_token %}

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >License's Full Name
        <span class="glyphicon glyphicon-question-sign" id="fullnameInfo" data-toggle="popover" data-placement="auto left"></span>
      </label>
        <div class="col-sm-4">
          {{ form.fullname }}
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >Short Identifier
        <span class="glyphicon glyphicon-question-sign" id="shortIdentifierInfo" data-toggle="popover" data-placement="auto left"></span>
      </label>
        <div class="col-sm-4">
          {{ form.shortIdentifier }}
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >Source / URL
        <span class="glyphicon glyphicon-question-sign" id="sourceUrlInfo" data-toggle="popover" data-placement="auto left"></span>
      </label>
        <div class="col-sm-4">
          {{ form.sourceUrl }}
          <span class="help-block" id="addSourceUrl" style="color:#3197c4; text-align: left; font-weight: bold; font-style: italic; cursor:pointer;" >+ Add a source</span>
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >&nbsp;OSI Status&nbsp;</label>
        <div class="col-sm-4">
          {{ form.osiApproved }}
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >Standard License Header
        <span class="glyphicon glyphicon-question-sign" id="licenseHeaderInfo" data-toggle="popover" data-placement="auto left"></span>
      </label>
        <div class="col-sm-6">
          {{ form.licenseHeader }}
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >License Text
        <span class="glyphicon glyphicon-question-sign" id="textInfo" data-toggle="popover" data-placement="auto left"></span>
      </label>
        <div class="col-sm-6">
          {{ form.text }}
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >Who is the license author or license steward?</label>
        <div class="col-sm-4">
          {{ form.licenseAuthorName }}
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >Email address</label>
        <div class="col-sm-4">
          {{ form.userEmail }}
        </div>
      </div>
    </div>

    <div class = "form-group">
      <div class="col-sm-12">
      <label class="control-label col-sm-3" >Comments
        <span class="glyphicon glyphicon-question-sign" id="commentsInfo" data-toggle="popover" data-placement="auto left"></span>
      </label>
        <div class="col-sm-6">
          {{ form.comments }}
        </div>
      </div>
    </div>
    <hr>
		<input type="hidden" id="cfileformat" name="submit" value="">
		<button class=" btn btn-md btn-info" id="submitbutton" type="submit" >Submit</button>
</form>
</div>
</div>
{% include "app/modal.html" %}
{% endblock %}

{% block script_block %}
<script type="text/javascript">
$(document).ready(function () {
    var is_touch_device = "ontouchstart" in document.documentElement;
    $('#fullnameInfo').popover({trigger: is_touch_device ? "click" : "hover", title: "License Full Name", content: "\u2022 The full name may omit certain word, such as 'the,' for alphabetical sorting purposes. \
    <br /> \u2022 No commas in full name of license or exception. \
    <br /> \u2022 The word 'version' is not spelled out; 'v' or nothing is used to indicate license version (for space reasons) \
    <br /> \u2022 For version, use lower case v and no period or space between v and the number. \
    <br /> \u2022 No abbreviations are included (in parenthesis) after the full name.", html: "true", viewport: '.panel-body', container: '.panel-body'});
    $('#shortIdentifierInfo').popover({trigger: is_touch_device ? "click" : "hover", title: "Short Identifier", content: "\u2022 Short identifier to be used to identify a license or exception match to licenses or exceptions in the context of an SPDX file, a source file, or elsewhere. \
    <br /> \u2022 Short identifiers consist of ASCII letters (A-Za-z), digits (0-9), full stops (.) and hyphen or minus signs (-) \
    <br /> \u2022 Short identifiers consist of an abbreviation based on a common short name or acronym for the license or exception. \
    <br /> \u2022 Where applicable, the abbreviation will be followed by a dash and then the version number, in X.Y format. \
    <br /> \u2022 Where applicable, and if possible, the short identifier should be harmonized with other well-known open source naming sources (i.e., OSI, Fedora, etc.) \
    <br /> \u2022 Short identifiers should be as short in length as possible while staying consistent with all other naming criteria.", html: "true", viewport: '.panel-body', container: 'body'});
    $('#sourceUrlInfo').popover({trigger: is_touch_device ? "click" : "hover", title: "Source URL", content: "\u2022 Include URL for the official text of the license or exception. \
    <br /> \u2022 If the license is OSI approved, also include URL for OSI license page. \
    <br /> \u2022 Include another URL that has text version of license, if neither of the first two options are available. \
    <br /> \u2022 Note that the source URL may refer to an original URL for the license which is no longer active. We don't remove inactive URLs. New or best available URLs may be added. \
    <br /> \u2022 Link to the license or exception in its native language is used where specified (e.g. French for CeCILL). Link to English version where multiple, equivalent official translations (e.g. EUPL)", html: "true", viewport: '.panel-body', container: '.panel-body'});
    $('#licenseHeaderInfo').popover({trigger: is_touch_device ? "click" : "hover", title: "Standard License Header", content: "\u2022 Should only include text intended to be put in the header of source files or other files as specified in the license or license appendix when specifically delineated. \
    <br /> \u2022 Indicate if there is any variation in the header (i.e. for files developed by a contributor versus when applying license to original work) \
    <br /> \u2022 Do not include NOTICE info intended for a separate notice file. \
    <br /> \u2022 Leave this field blank if there is no standard header as specifically defined in the license.", html: "true", viewport: '.panel-body', container: '.panel-body'});
    $('#commentsInfo').popover({trigger: is_touch_device ? "click" : "hover", title: "Comments", content: "\u2022 Provide a short explanation regarding the need for this license or exception to be included on the SPDX License List. \
    <br /> \u2022 Identify at least one program that uses it or any other related information.", html: "true", viewport: '.panel-body', container: '.panel-body'});
    $('#textInfo').popover({trigger: is_touch_device ? "click" : "hover", title: "License Text", content: "Full license of the license text.", viewport: '.panel-body', container: '.panel-body'});
    $("#submitnewlicensepage").addClass('linkactive');
    $('input').addClass('form-control');
    $('select').addClass('form-control');
    $('textarea').addClass('form-control');
	var githubLogin = $("#githubLogin").text();
	/* if user not authenticated using GitHub, display modal with login button */
	if(githubLogin == "False"){
		$("#modal-header").removeClass("red-modal green-modal");
		$("#modal-header").addClass("yellow-modal");
		$(".modal-footer").html('<button class="btn btn-success" id="github_auth_begin"><span class="glyphicon glyphicon-ok"></span> Confirm</button>');
		$("#modal-body").html('To submit a license, you must log in using Github.  You will now be redirected to the github login.  Please allow the requested permissions.  If you do not have a github account, you can <a href="https://github.com/">sign up</a> for free or you can email your new license request to <a href="mailto:spdx-legal@spdx.org">spdx-legal@spdx.org</a>.');
        $("#myModal").modal({
           backdrop: 'static',
           keyboard: true,
           show: true
        });
	}
});
</script>
<script type="text/javascript">
	$(document).on('click','button#github_auth_begin',function(event){
    event.preventDefault();
    var githubLoginLink = $("#githubLoginLink").text();
    var page_url = window.location.href;
    githubLoginLink += "?next=" + page_url;
    window.location = githubLoginLink;
  });
</script>
<script type="text/javascript">
$(document).on('click', '#addSourceUrl', function(){
    var html = '<div class="col-sm-12 btn-group" style="padding:6px 0; margin-top:2"><input type="text" class="form-control" id="sourceUrl" placeholder="" name = "sourceurl"></div>';
  $('#addSourceUrl').before(html);
});
</script>

<script type="text/javascript">
function checkform() {
  $(".form-control").removeAttr('style');
  if ($('#fullname').val().trim() === "") {
    scrollUpAndHighlight($('#fullname'))
    return ("Please enter the license fullname.");
  }
  else if (($('#shortIdentifier').val().trim() == "")){
    scrollUpAndHighlight($('#shortIdentifier'))
    return("Please enter the identifier.");
  }
  else if (!validate_urls()){
    scrollUpAndHighlight($('#sourceUrl'))
    return("Please enter a valid URL.");
  }
  else if (($('#osiApproved').val() == "0")){
    scrollUpAndHighlight($('#osiApproved'))
    return("Please select if the OSI is approved or not.");
  }
  else if (($('#text').val().trim() == "")){
    scrollUpAndHighlight($('#text'))
    return("Please enter the license text.");
  }
  else {
    return "1";
  }
}

function validate_urls(){
  var valid_urls = true;
  url_schema = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;
  $('input[id="sourceUrl"]').each(function(){
    if(!url_schema.test($(this).val())){
      valid_urls = false;
    }
  })
  return valid_urls;
}

/* Function to scroll at the top of the page and highlight the error field in red. */
function scrollUpAndHighlight(element) {
  $('html, body').animate({scrollTop: 50}, 500); 
  $(element).css({ 'border-color':'#f00','box-shadow': '1px 1px 8px #f04a4a' });
}

</script>

<script type="text/javascript">
  $('#newlicense').on('submit', function(event){
    event.preventDefault();
    var check = checkform();
    if (check=="1"){
      $("#submitbutton").text("Submitting...");
      $("#submitbutton").prop('disabled', true);
      $("#messages").html("");
      var form = new FormData($("#newlicense")[0]);
      $.ajax({
              type: "POST",
              enctype: 'multipart/form-data',
              url: "/app/submit_new_license/",
              processData: false,
              contentType: false,
              cache: false,
              timeout: 600000,
              data: form,
              success: function (data) {
                var githubCode = data.statusCode;
                if(githubCode == '201'){
                  var successMessage = "The license request has been successfully submitted.";
                  $("#messages").html('<div class="alert alert-success alert-dismissable fade in"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Success! </strong>'+ successMessage +'</div>');
                      setTimeout(function() {
                        $("#messages").html("");
                      }, 7000);
                }
                else{
                  var warningMessage = "Please note that there was a problem opening the issue for the SPDX legal team. Please email spdx-legal@lists.spdx.org with SPDX ID for the license you are submitting";
                  $("#messages").html('<div class="alert alert-warning alert-dismissable fade in"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Warning! </strong>'+ warningMessage +'</div>');
                      setTimeout(function() {
                        $("#messages").html("");
                      }, 7000);
                }
                $("#fullname").val("");
                $("#shortIdentifier").val("");
                $("#sourceUrl").val("");
                $("#osiApproved").val(0);
                $("#comments").val("");
                $("#licenseHeader").val("");
                $("#text").val("");
                $("#userEmail").val("");
                var sources = $('[id="sourceUrl"]');
                if(sources.length > 1){
                  for (var i = 1; i < sources.length; i++) {
                    sources[i].remove();
                  }
                }
                $("#submitbutton").text("Submit");
                $("#submitbutton").prop('disabled', false);
              },
              error: function (e) {
                  console.log("ERROR : ", e);
                  $("#modal-header").removeClass("green-modal");
                  try {
                    var obj = JSON.parse(e.responseText);
                    if (obj.type=="warning" || obj.type=="rate_limit"){
                      $("#modal-header").removeClass("red-modal");
                      $("#modal-header").addClass("yellow-modal");
                      $("#modal-title").html("Warning!");
                    }
                  else if (obj.type=="error"){
                      $("#modal-header").removeClass("yellow-modal");
                      $("#modal-header").addClass("red-modal");
                      $("#modal-title").html("Error!");
                    }
                  $("#modal-body").text(obj.data);
                  }
                  catch (e){
                    $("#modal-header").removeClass("yellow-modal");
                    $("#modal-header").addClass("red-modal");
                    $("#modal-title").html("Error!");
                    $("#modal-body").text("The application could not be connected. Please try later.");
                  }
                  $("#myModal").modal({
                          backdrop: 'static',
                          keyboard: true,
                          show: true
                  });
                  $("#submitbutton").text("Submit");
                  $("#submitbutton").prop('disabled', false);
              }
          });
    }
    else{
      $("#messages").html('<div class="alert alert-danger alert-dismissable fade in"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Error! </strong>'+check+'</div>');
      setTimeout(function() {
        $("#messages").html("");
      }, 5000);
    }
});
</script>
{% endblock %}

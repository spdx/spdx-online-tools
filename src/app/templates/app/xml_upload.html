{% extends 'app/base.html' %}
{% load static %}
{% load staticfiles %}

{% block head_block %}
  <link href="{% static 'css/dragdrop.css' %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block body1 %}
<div id="messages" class="messages"> </div>
<p class ="lead"> {{ error }} </p>

<div class="panel panel-default">
  <div class="panel-heading"> <p class="lead">Upload the XML File</p> </div>
    <div class="panel-body">
  
      <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#text">XML Text</a></li>
        <li><a data-toggle="tab" href="#upload">Upload File</a></li>
        <li><a data-toggle="tab" href="#license-name">License Name</a></li>
        <li><a data-toggle="tab" href="#new">New License XML</a></li>
      </ul>

      <div class="tab-content">
        <div id="text" class="tab-pane fade in active">
          <form id="form-text" enctype="multipart/form-data" class="form-horizontal" method="post">
            {% csrf_token %}
            <h4>Write the XML document text below: </h4>
            <textarea id="xmltext" name="xmltext" rows="15" style="width: 90%; resize:none;"></textarea> <hr>
            <button id="xmlTextButton" name="xmlTextButton" class=" btn btn-md btn-info" type="submit">Edit Document</button>
          </form>
        </div>
        <div id="upload" class="tab-pane fade">
          <div id="drop-area" class="container">
            <form id="form-upload" enctype="multipart/form-data" class="form-horizontal" method="post">
              {% csrf_token %}
              <h4>Upload XML file using the button or by dragging and dropping onto the dashed region</h4>
              <input type="file" id="file" accept="application/xml" onchange="handleFiles(this.files)">
              <label class="button" for="file">Select XML file</label>
              <div class="file-name">No file selected</div>
            </form>
          </div>
          <button id="uploadButton" name="uploadButton" class="btn btn-md btn-info" type="submit">Edit Document</button>
        </div>
        <div id="license-name" class="tab-pane fade">
          <form id="form-license-name" enctype="multipart/form-data" class="form-horizontal" method="post">
            {% csrf_token %}
            <div class="container" style="margin-top:20px;">
              <label class="control-label col-sm-6" >License Full Name or Identifier as on SPDX License List:</label>
              <div class="col-sm-6" style="text-align:left;"> 
                <input type="text" id="licenseName" placeholder="License Name" list="license_names" name="licenseName" autocomplete="off" autofocus style="width:280px;">
                <datalist id="license_names"></datalist>
              </div>
            </div> <hr>
            <button id="licenseNameButton" name="licenseNameButton" class="btn btn-md btn-info" type="submit">Edit Document</button>
          </form>
        </div>
        <div id="new" class="tab-pane fade">
          <form id="form-new" enctype="multipart/form-data" class="form-horizontal" method="post">
            {% csrf_token %}
            <h3>Make a new License XML file from scratch</h3><br>
            <button id="new-button" name="new-button" class="btn btn-l btn-info" type="submit">Go</button>
          </form>
        </div>
  </div>
  {% include "app/modal.html" %} 
  </div>
</div>
{% endblock %}

{% block script_block %}
<script type="text/javascript">
  /* Javascript to handel drag and drop */
  let dropArea = document.getElementById('drop-area');
  var xml_file="", valid=false;
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false)
  });
  
  function preventDefaults (e) {
    e.preventDefault()
    e.stopPropagation()
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false)
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false)
  });
  
  function highlight(e) {
    dropArea.classList.add('highlight')
  }
  
  function unhighlight(e) {
    dropArea.classList.remove('highlight')
  }
  
  dropArea.addEventListener('drop', handleDrop, false)

  function handleDrop(e) {
    let dt = e.dataTransfer
    let files = dt.files
    handleFiles(files)
  }

  function handleFiles(files) {
    ([...files]).forEach(checkFile)
  }
  
  function checkFile(file){
    if(file.type=="text/xml" || file.type=="application/xml"){
      $(".file-name").html("<b>Selected File: </b>"+file.name);
      $(".file-name").removeClass("fail");
      $(".file-name").addClass("success");
      valid = true;
      xml_file = file;
    }
    else{
      $(".file-name").html("<b>Selected File: </b>"+file.name);
      $(".file-name").removeClass("success");
      $(".file-name").addClass("fail");
      valid = false;
    }
  }

</script>

<script type="text/javascript">
  
  function button_change(state){
    /* to change the state of submit button */
    if(state == 0){
      $("#licenseNameButton,#uploadButton,#xmlTextButton,#new-button").text("Processing...");
      $("#licenseNameButton,#uploadButton,#xmlTextButton,#new-button").prop('disabled', true);
    }
    else if(state==1){
      $("#licenseNameButton,#uploadButton,#xmlTextButton,#new-button").text("Edit Document");
      $("#licenseNameButton,#uploadButton,#xmlTextButton,#new-button").prop('disabled', false);
    }
  }

  function random_string(){
    return Math.random().toString(36).substring(2);
  }

  function send_request(form){
    /* sending the request */
    $.ajax({
      type: "POST",
      enctype: 'multipart/form-data',
      url: "/app/xml_upload/",
      processData: false,
      contentType: false,
      cache: false,
      dataType: 'json',
      timeout: 600000,
      data: form,
      success: function (data) {
        window.location.href = data.redirect_url;
      },
      error: function (e) {
        console.log("ERROR : ", e);
        $("#modal-header").removeClass("green-modal");
        try {
          var obj = JSON.parse(e.responseText);
          if (obj.type=="warning"){
            $("#modal-header").removeClass("red-modal");
            $("#modal-header").addClass("yellow-modal");
            $("#modal-title").html("Warning!");
        }
          else if (obj.type=="error"){
            $("#modal-header").removeClass("yellow-modal");
            $("#modal-header").addClass("red-modal");
            $("#modal-title").html("Error!");
          }
          $("#modal-body").text(obj.data);
        }
        catch (e){
          $("#modal-header").removeClass("yellow-modal");
          $("#modal-header").addClass("red-modal");
          $("#modal-title").html("Error!");
          $("#modal-body").text("The application could not be connected. Please try later.");
        }
        $("#myModal").modal({
          backdrop: 'static',
          keyboard: true, 
          show: true
        });
        button_change(1);
      }
    });
  }

  $("#form-text").on('submit', function(event){
    /* if user submits xml using the textarea */
    event.preventDefault();
    if($("#xmltext").val().length>0){
      button_change(0);
      $("#messages").html("");
      var form = new FormData($("#form-text")[0]);
      form.append("xmlTextButton","xmlTextButton");
      form.append("page_id",random_string());
      send_request(form);
    }
    else{
      display_message("No license XML text provided. Please input some license XML text to edit.");
      button_change(1);
    }
  })

  function check_upload_form(){
    if(valid==false){
      return "Please select a SPDX license XML file.";
    }
    else if(xml_file==""){
      return "No file selected. Please select a SPDX license file to edit.";
    }
    else{
      return 1;
    }
  }

  $("#uploadButton").on('click', function(event){
    /* if the user uploads the file */
    event.preventDefault();
    if(check_upload_form()==1){
      button_change(0);
      $("#messages").html("");
      var form = new FormData($("#form-upload")[0]);
      form.append("file",xml_file);
      form.append("uploadButton","uploadButton");
      form.append("page_id",random_string());
      send_request(form);
    }
    else{
      display_message(check_upload_form());
      button_change(1);
    }
  })

  $("#form-license-name").on('submit', function(event){
    /* if the user enters license name */
    event.preventDefault();
    if($("#licenseName").val().length>0){
      button_change(0);
      $("#messages").html("");
      var form = new FormData($("#form-license-name")[0]);
      form.append("licenseNameButton","licenseNameButton");
      form.append("page_id",random_string());
      send_request(form);
    }
    else{
      display_message("Please provide a SPDX license or exception name.");
      $("#licenseName").focus();
    }
  })

  $("#form-new").on('submit', function(event){
    event.preventDefault();
    button_change(0);
    $("#messages").html("");
    var form = new FormData($("#form-license-name")[0]);
    form.append("newButton","newButton");
    form.append("page_id",random_string());
    send_request(form);
  })

  function display_message(message_text){
    $("#messages").html('<div class="alert alert-danger alert-dismissable fade in"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Error! </strong>'+message_text+'</div>');
    setTimeout(function() {
      $("#messages").html("");
    }, 5000);
  }

</script>

<script type="text/javascript">
  $(document).ready(function () {
    /* Add suggestions for license name input */
    var license_names = ['BSD Zero Clause License', 'Attribution Assurance License', 'Amazon Digital Services License', 'Academic Free License v1.1', 'Academic Free License v1.2', 'Academic Free License v2.0', 'Academic Free License v2.1', 'Academic Free License v3.0', 'Affero General Public License v1.0 only', 'Affero General Public License v1.0 or later', 'GNU Affero General Public License v3.0 only', 'GNU Affero General Public License v3.0 or later', "AMD's plpa_map.c License", 'Apple MIT License', 'Academy of Motion Picture Arts and Sciences BSD', 'ANTLR Software Rights Notice', 'Adobe Postscript AFM License', 'Adaptive Public License 1.0', 'Apple Public Source License 1.0', 'Apple Public Source License 1.1', 'Apple Public Source License 1.2', 'Apple Public Source License 2.0', 'Abstyles License', 'Adobe Systems Incorporated Source Code License Agreement', 'Adobe Glyph List License', 'Afmparse License', 'Aladdin Free Public License', 'Apache License 1.0', 'Apache License 1.1', 'Apache License 2.0', 'Artistic License 1.0 (Perl)', 'Artistic License 1.0 w/clause 8', 'Artistic License 1.0', 'Artistic License 2.0', 'BSD 1-Clause License', 'BSD 2-Clause FreeBSD License', 'BSD 2-Clause NetBSD License', 'BSD-2-Clause Plus Patent License', 'BSD 2-Clause "Simplified" License', 'BSD with attribution', 'BSD 3-Clause Clear License', 'Lawrence Berkeley National Labs BSD variant license', 'BSD 3-Clause No Nuclear License 2014', 'BSD 3-Clause No Nuclear License', 'BSD 3-Clause No Nuclear Warranty', 'BSD 3-Clause "New" or "Revised" License', 'BSD-4-Clause (University of California-Specific)', 'BSD 4-Clause "Original" or "Old" License', 'BSD Protection License', 'BSD Source Code Attribution', 'Boost Software License 1.0', 'Bahyph License', 'Barr License', 'Beerware License', 'BitTorrent Open Source License v1.0', 'BitTorrent Open Source License v1.1', 'Borceux license', 'Computer Associates Trusted Open Source License 1.1', 'Creative Commons Attribution 1.0 Generic', 'Creative Commons Attribution 2.0 Generic', 'Creative Commons Attribution 2.5 Generic', 'Creative Commons Attribution 3.0 Unported', 'Creative Commons Attribution 4.0 International', 'Creative Commons Attribution Non Commercial 1.0 Generic', 'Creative Commons Attribution Non Commercial 2.0 Generic', 'Creative Commons Attribution Non Commercial 2.5 Generic', 'Creative Commons Attribution Non Commercial 3.0 Unported', 'Creative Commons Attribution Non Commercial 4.0 International', 'Creative Commons Attribution Non Commercial No Derivatives 1.0 Generic', 'Creative Commons Attribution Non Commercial No Derivatives 2.0 Generic', 'Creative Commons Attribution Non Commercial No Derivatives 2.5 Generic', 'Creative Commons Attribution Non Commercial No Derivatives 3.0 Unported', 'Creative Commons Attribution Non Commercial No Derivatives 4.0 International', 'Creative Commons Attribution Non Commercial Share Alike 1.0 Generic', 'Creative Commons Attribution Non Commercial Share Alike 2.0 Generic', 'Creative Commons Attribution Non Commercial Share Alike 2.5 Generic', 'Creative Commons Attribution Non Commercial Share Alike 3.0 Unported', 'Creative Commons Attribution Non Commercial Share Alike 4.0 International', 'Creative Commons Attribution No Derivatives 1.0 Generic', 'Creative Commons Attribution No Derivatives 2.0 Generic', 'Creative Commons Attribution No Derivatives 2.5 Generic', 'Creative Commons Attribution No Derivatives 3.0 Unported', 'Creative Commons Attribution No Derivatives 4.0 International', 'Creative Commons Attribution Share Alike 1.0 Generic', 'Creative Commons Attribution Share Alike 2.0 Generic', 'Creative Commons Attribution Share Alike 2.5 Generic', 'Creative Commons Attribution Share Alike 3.0 Unported', 'Creative Commons Attribution Share Alike 4.0 International', 'Creative Commons Zero v1.0 Universal', 'Common Development and Distribution License 1.0', 'Common Development and Distribution License 1.1', 'Community Data License Agreement Permissive 1.0', 'Community Data License Agreement Sharing 1.0', 'CeCILL Free Software License Agreement v1.0', 'CeCILL Free Software License Agreement v1.1', 'CeCILL Free Software License Agreement v2.0', 'CeCILL Free Software License Agreement v2.1', 'CeCILL-B Free Software License Agreement', 'CeCILL-C Free Software License Agreement', 'CNRI Jython License', 'CNRI Python Open Source GPL Compatible License Agreement', 'CNRI Python License', 'Common Public Attribution License 1.0', 'Common Public License 1.0', 'Code Project Open License 1.02', 'CUA Office Public License v1.0', 'Caldera License', 'Clarified Artistic License', 'Condor Public License v1.1', 'Crossword License', 'CrystalStacker License', 'Cube License', 'Deutsche Freie Software Lizenz', 'DOC License', 'DSDP License', 'Dotseqn License', 'Educational Community License v1.0', 'Educational Community License v2.0', 'Eiffel Forum License v1.0', 'Eiffel Forum License v2.0', 'Eclipse Public License 1.0', 'Eclipse Public License 2.0', 'EU DataGrid Software License', 'European Union Public License 1.0', 'European Union Public License 1.1', 'European Union Public License 1.2', 'Entessa Public License v1.0', 'Erlang Public License v1.1', 'Eurosym License', 'FSF All Permissive License', 'FSF Unlimited License', 'FSF Unlimited License (with License Retention)', 'Freetype Project License', 'Fair License', 'Frameworx Open License 1.0', 'FreeImage Public License v1.0', 'GNU Free Documentation License v1.1 only', 'GNU Free Documentation License v1.1 or later', 'GNU Free Documentation License v1.2 only', 'GNU Free Documentation License v1.2 or later', 'GNU Free Documentation License v1.3 only', 'GNU Free Documentation License v1.3 or later', 'GL2PS License', 'GNU General Public License v1.0 only', 'GNU General Public License v1.0 or later', 'GNU General Public License v2.0 only', 'GNU General Public License v2.0 or later', 'GNU General Public License v3.0 only', 'GNU General Public License v3.0 or later', 'Giftware License', '3dfx Glide License', 'Glulxe License', 'Historical Permission Notice and Disclaimer', 'Haskell Language Report License', 'IBM PowerPC Initialization and Boot Software', 'ICU License', 'Independent JPEG Group License', 'IPA Font License', 'IBM Public License v1.0', 'ISC License', 'ImageMagick License', 'Imlib2 License', 'Info-ZIP License', 'Intel ACPI Software License Agreement', 'Intel Open Source License', 'Interbase Public License v1.0', 'JSON License', 'JasPer License', 'Licence Art Libre 1.2', 'Licence Art Libre 1.3', 'GNU Library General Public License v2 only', 'GNU Library General Public License v2 or later', 'GNU Lesser General Public License v2.1 only', 'GNU Lesser General Public License v2.1 or later', 'GNU Lesser General Public License v3.0 only', 'GNU Lesser General Public License v3.0 or later', 'Lesser General Public License For Linguistic Resources', 'Lucent Public License Version 1.0', 'Lucent Public License v1.02', 'LaTeX Project Public License v1.0', 'LaTeX Project Public License v1.1', 'LaTeX Project Public License v1.2', 'LaTeX Project Public License v1.3a', 'LaTeX Project Public License v1.3c', 'Latex2e License', 'Leptonica License', 'Licence Libre du Québec – Permissive version 1.1', 'Licence Libre du Québec – Réciprocité version 1.1', 'Licence Libre du Québec – Réciprocité forte version 1.1', 'libpng License', 'Linux Kernel Variant of OpenIB.org license', 'MIT No Attribution', 'CMU License', 'Enlightenment License (e16)', 'enna License', 'feh License', 'MIT License', 'MIT +no-false-attribs license', 'Mozilla Public License 1.0', 'Mozilla Public License 1.1', 'Mozilla Public License 2.0 (no copyleft exception)', 'Mozilla Public License 2.0', 'Microsoft Public License', 'Microsoft Reciprocal License', 'Matrix Template Library License', 'MakeIndex License', 'MirOS License', 'Motosoto License', 'Multics License', 'Mup License', 'NASA Open Source Agreement 1.3', 'Net Boolean Public License v1', 'University of Illinois/NCSA Open Source License', 'Nethack General Public License', 'Norwegian Licence for Open Government Data', 'No Limit Public License', 'Netizen Open Source License', 'Netscape Public License v1.0', 'Netscape Public License v1.1', 'Non-Profit Open Software License 3.0', 'NRL License', 'NTP License', 'Naumen Public License', 'Net-SNMP License', 'NetCDF license', 'Newsletr License', 'Nokia Open Source License', 'Noweb License', 'Open CASCADE Technology Public License', 'OCLC Research Public License 2.0', 'ODC Open Database License v1.0', 'SIL Open Font License 1.0', 'SIL Open Font License 1.1', 'Open Group Test Suite License', 'Open LDAP Public License v1.1', 'Open LDAP Public License v1.2', 'Open LDAP Public License v1.3', 'Open LDAP Public License v1.4', 'Open LDAP Public License v2.0.1', 'Open LDAP Public License v2.0 (or possibly 2.0A and 2.0B)', 'Open LDAP Public License v2.1', 'Open LDAP Public License v2.2.1', 'Open LDAP Public License 2.2.2', 'Open LDAP Public License v2.2', 'Open LDAP Public License v2.3', 'Open LDAP Public License v2.4', 'Open LDAP Public License v2.5', 'Open LDAP Public License v2.6', 'Open LDAP Public License v2.7', 'Open LDAP Public License v2.8', 'Open Market License', 'Open Public License v1.0', 'OSET Public License version 2.1', 'Open Software License 1.0', 'Open Software License 1.1', 'Open Software License 2.0', 'Open Software License 2.1', 'Open Software License 3.0', 'OpenSSL License', 'ODC Public Domain Dedication & License 1.0', 'PHP License v3.0', 'PHP License v3.01', 'Plexus Classworlds License', 'PostgreSQL License', 'Python License 2.0', 'Q Public License 1.0', 'Qhull License', 'Red Hat eCos Public License v1.1', 'Reciprocal Public License 1.1', 'Reciprocal Public License 1.5', 'RealNetworks Public Source License v1.0', 'RSA Message-Digest License ', 'Ricoh Source Code Public License', 'Rdisc License', 'Ruby License', 'Sax Public Domain Notice', 'SCEA Shared Source License', 'SGI Free Software License B v1.0', 'SGI Free Software License B v1.1', 'SGI Free Software License B v2.0', 'Sun Industry Standards Source License v1.2', 'Sun Industry Standards Source License v1.1', 'Standard ML of New Jersey License', 'Secure Messaging Protocol Public License', 'SNIA Public License 1.1', 'Sun Public License v1.0', 'Scheme Widget Library (SWL) Software License Agreement', 'Saxpath License', 'Sendmail License', 'Simple Public License 2.0', 'Sleepycat License', 'Spencer License 86', 'Spencer License 94', 'Spencer License 99', 'SugarCRM Public License v1.1.3', 'TCL/TK License', 'TCP Wrappers License', 'TMate Open Source License', 'TORQUE v2.5+ Software License v1.1', 'Trusster Open Source License', 'Universal Permissive License v1.0', 'Unicode License Agreement - Data Files and Software (2015)', 'Unicode License Agreement - Data Files and Software (2016)', 'Unicode Terms of Use', 'The Unlicense', 'VOSTROM Public License for Open Source', 'Vovida Software License v1.0', 'Vim License', 'W3C Software Notice and License (1998-07-20)', 'W3C Software Notice and Document License (2015-05-13)', 'W3C Software Notice and License (2002-12-31)', 'Do What The F*ck You Want To Public License', 'Sybase Open Watcom Public License 1.0', 'Wsuipa License', 'X11 License', 'XFree86 License 1.1', 'XSkat License', 'Xerox License', 'X.Net License', 'Yahoo! Public License v1.0', 'Yahoo! Public License v1.1', 'Zope Public License 1.1', 'Zope Public License 2.0', 'Zope Public License 2.1', 'Zed License', 'Zend License v2.0', 'Zimbra Public License v1.3', 'Zimbra Public License v1.4', 'zlib License', 'bzip2 and libbzip2 License v1.0.5', 'bzip2 and libbzip2 License v1.0.6', 'curl License', 'diffmark license', 'dvipdfm License', 'eGenix.com Public License 1.1.0', 'gSOAP Public License v1.3b', 'gnuplot License', 'iMatix Standard Function Library Agreement', 'libtiff License', 'mpich2 License', 'psfrag License', 'psutils License', 'xinetd License', 'XPP License', 'zlib/libpng License with Acknowledgement', 'Affero General Public License v1.0', 'GNU Affero General Public License v3.0', 'GNU Free Documentation License v1.1', 'GNU Free Documentation License v1.2', 'GNU Free Documentation License v1.3', 'GNU General Public License v1.0 or later', 'GNU General Public License v1.0 only', 'GNU General Public License v2.0 or later', 'GNU General Public License v2.0 w/GCC Runtime Library exception', 'GNU General Public License v2.0 w/Autoconf exception', 'GNU General Public License v2.0 w/Bison exception', 'GNU General Public License v2.0 w/Classpath exception', 'GNU General Public License v2.0 w/Font exception', 'GNU General Public License v2.0 only', 'GNU General Public License v3.0 or later', 'GNU General Public License v3.0 w/GCC Runtime Library exception', 'GNU General Public License v3.0 w/Autoconf exception', 'GNU General Public License v3.0 only', 'GNU Library General Public License v2 or later', 'GNU Library General Public License v2 only', 'GNU Library General Public License v2.1 or later', 'GNU Lesser General Public License v2.1 only', 'GNU Lesser General Public License v3.0 or later', 'GNU Lesser General Public License v3.0 only', 'Nunit License', 'Standard ML of New Jersey License', 'eCos license version 2.0', 'wxWindows Library License'];
    var exception_names = ['389 Directory Server Exception', 'Autoconf exception 2.0', 'Autoconf exception 3.0', 'Bison exception 2.2', 'Bootloader Distribution Exception', 'CLISP exception 2.0', 'Classpath exception 2.0', 'DigiRule FOSS License Exception', 'FLTK exception', 'Fawkes Runtime Exception', 'Font exception 2.0', 'GCC Runtime Library exception 2.0', 'GCC Runtime Library exception 3.1', 'LLVM Exception', 'LZMA exception', 'Libtool Exception', 'Linux Syscall Note', 'Nokia Qt LGPL exception 1.1', 'Open CASCADE Exception 1.0', 'OpenJDK Assembly exception 1.0', 'Qwt exception 1.0', 'WxWindows Library Exception 3.1', 'eCos exception 2.0', 'FreeRTOS Exception 2.0', 'GNU JavaMail exception', 'i2p GPL+Java Exception', 'Macros and Inline Functions Exception', 'OpenVPN OpenSSL Exception', 'U-Boot exception 2.0'];
    for(i=0;i<license_names.length;i++){
      $("#license_names").append('<option value="'+license_names[i]+'">');
    }
    for(i=0;i<exception_names.length;i++){
      $("#license_names").append('<option value="'+exception_names[i]+'">');
    }
    $("#xml-editor").addClass('linkactive');
  });
</script>

{% endblock %}
